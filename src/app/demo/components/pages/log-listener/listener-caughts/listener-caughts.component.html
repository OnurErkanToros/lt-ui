<p-toast />
<p-toolbar styleClass="mb-4 gap-2">
    <ng-template pTemplate="left"> </ng-template>
    <ng-template pTemplate="right">
        <p-button
            pRipple
            severity="warning"
            label="Banla"
            icon="pi pi-plus"
            (click)="setBanSuspectIp()"
            [disabled]="getSelectedIpListType() !== 'NEW'"
        />
        <p-button
            class="ml-2"
            pRipple
            severity="danger"
            label="Ban kaldır"
            icon="pi pi-minus"
            (click)="setUnbanSuspectIp()"
            [disabled]="getSelectedIpListType() !== 'BANNED'"
        />
    </ng-template>
</p-toolbar>

<p-table
    #dt
    [value]="suspectIpList"
    [rows]="6"
    [tableStyle]="{ 'min-width': '75rem' }"
    paginator="true"
    [rowHover]="true"
    dataKey="id"
    currentPageReportTemplate="{totalRecords} kayıttan {first} - {last} arası gösteriliyor"
    [showCurrentPageReport]="true"
    [(selection)]="selectedSuspectIpList"
>
    <ng-template pTemplate="caption">
        <form [formGroup]="searchFormGroup" (ngSubmit)="searchSubmit()">
            <div class="flex align-items-center justify-content-between">
                <h5 class="m-0">Log Dinleyicinin Yakaladığı IP Adresleri</h5>

                <span class="p-input-icon-left ml-auto">
                    <i class="pi pi-search"></i>
                    <input
                        pInputText
                        type="text"
                        formControlName="ip"
                        placeholder="IP girebilirsiniz"
                    />
                </span>

                <span class="p-input-icon-left ml-2">
                    <i class="pi pi-search"></i>
                    <input
                        pInputText
                        type="text"
                        formControlName="host"
                        placeholder="Host girebilirsiniz"
                    />
                </span>

                <p-selectButton
                    [options]="statusOptions"
                    formControlName="status"
                    [multiple]="false"
                    optionLabel="name"
                    optionValue="value"
                    class="ml-2"
                />

                <p-button type="submit" class="ml-2">Ara</p-button>
            </div>
        </form>
    </ng-template>
    <ng-template pTemplate="header">
        <tr>
            <th style="width: 4rem">
                <p-tableHeaderCheckbox />
            </th>
            <th>IP Adresi</th>
            <th>Hangi hosttan gelmiş</th>
            <th>Oluşturulma Tarihi</th>
            <th>Durum</th>
            <th>Durum Güncellenme</th>
            <th>Durum Güncelleyen</th>
            <th></th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-suspect>
        <tr>
            <td>
                <p-tableCheckbox [value]="suspect" />
            </td>
            <td>
                {{ suspect.ip }}
            </td>
            <td>
                {{ suspect.host }}
            </td>
            <td>
                {{ suspect.createdAt | date : "dd MMMM yyyy, EEEE HH:mm" }}
            </td>
            <td>
                {{ suspect.status }}
            </td>
            <td>
                {{ suspect.statusAt | date : "dd MMMM yyyy, EEEE HH:mm" }}
            </td>
            <td>
                {{ suspect.statusBy }}
            </td>
            <td>
                <p-button
                    severity="help"
                    label="Detay"
                    icon="pi pi-info-circle"
                    class="mr-2"
                    (click)="showLineDetailDialog(suspect)"
                />
                <p-button
                    severity="info"
                    label="Abuse Sorgulaması"
                    icon="pi pi-search"
                    class="mr-2"
                    (click)="checkIpAddress(suspect.ip)"
                />
            </td>
        </tr>
    </ng-template>
</p-table>

<p-dialog
    header="{{ selectedSuspectIp.ip }} detayı"
    [modal]="true"
    [(visible)]="visibleDetail"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
>
    <div>
        <div class="flex flex-column justify-content-between h-full">
            <p-fieldset
                legend="Hangi hosttan geldi?"
                [toggleable]="true"
                [collapsed]="true"
                class="mb-2"
            >
                <p class="m-0">
                    {{ selectedSuspectIp.host }}
                </p>
            </p-fieldset>
            <p-fieldset
                legend="Ne zaman geldi?"
                [toggleable]="true"
                [collapsed]="true"
                class="mb-2"
            >
                <p class="m-0">
                    {{
                        selectedSuspectIp.createdAt
                            | date : "dd MMMM yyyy, EEEE HH:mm"
                    }}
                </p>
            </p-fieldset>
            <p-fieldset
                legend="Satır detayı"
                [toggleable]="true"
                [collapsed]="true"
                class="mb-2"
            >
                <p class="m-0">
                    {{ selectedSuspectIp.line }}
                </p>
            </p-fieldset>
            <p-fieldset
                legend="Regex"
                [toggleable]="true"
                [collapsed]="true"
                class="mb-2"
            >
                <p class="m-0">
                    {{ selectedSuspectIp.pattern }}
                </p>
            </p-fieldset>
            <p-fieldset
                legend="Durumu"
                [toggleable]="true"
                [collapsed]="true"
                class="mb-2"
            >
                <p class="m-0">
                    {{ selectedSuspectIp.status }}
                </p>
            </p-fieldset>
            <p-fieldset
                legend="Durum değişiklik zamanı"
                [toggleable]="true"
                [collapsed]="true"
                class="mb-2"
            >
                <p class="m-0">
                    {{ selectedSuspectIp.statusAt }}
                </p>
            </p-fieldset>
            <p-fieldset
                legend="Durum değiştiren"
                [toggleable]="true"
                [collapsed]="true"
                class="mb-2"
            >
                <p class="m-0">
                    {{ selectedSuspectIp.statusBy }}
                </p>
            </p-fieldset>
        </div>
    </div>
</p-dialog>

<p-dialog
    header="{{ abuseCheckResponse.ipAddress }} sonucu"
    [modal]="true"
    [(visible)]="visibleAbuseDetail"
    draggable="false"
    maximizable="true"
>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"><strong>IP Adresi:</strong></label>
        <span>{{ abuseCheckResponse.ipAddress }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"
            ><strong>IP Versiyon:</strong></label
        >
        <span>{{ abuseCheckResponse.ipVersion }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"
            ><strong>İnternet Sağlayıcı:</strong></label
        >
        <span>{{ abuseCheckResponse.isp }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"><strong>Ülke:</strong></label>
        <span>{{
            getCountryNameByCountryCode(abuseCheckResponse.countryCode)
        }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"
            ><strong>Toplam Raporlama Sayısı:</strong></label
        >
        <span>{{ abuseCheckResponse.totalReports }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"
            ><strong>Kaç Farklı Kişi Raporladı:</strong></label
        >
        <span>{{ abuseCheckResponse.numDistinctUsers }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"
            ><strong>Abuse Risk Puanı:</strong></label
        >
        <span>{{ abuseCheckResponse.abuseConfidenceScore }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"><strong>Domain:</strong></label>
        <span>{{ abuseCheckResponse.domain }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"><strong>Public mi?:</strong></label>
        <span>{{
            abuseCheckResponse.isPublic === true ? "Evet" : "Hayır"
        }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"><strong>Tor mu?:</strong></label>
        <span>{{ abuseCheckResponse.isTor === true ? "Evet" : "Hayır" }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"
            ><strong>Abuse Beyaz Listesinde mi?:</strong></label
        >
        <span>{{
            abuseCheckResponse.isWhitelisted === true ? "Evet" : "Hayır"
        }}</span>
    </div>
    <div class="flex align-items-center gap-3 mb-3">
        <label class="font-semibold w-6rem"
            ><strong>Abuse Beyaz Listesinde mi?:</strong></label
        >
        <span>{{
            abuseCheckResponse.isWhitelisted === true ? "Evet" : "Hayır"
        }}</span>
    </div>
    <div class="flex justify-content-end gap-2">
        <p-button label="Listeye Ekle" />
    </div>
</p-dialog>
